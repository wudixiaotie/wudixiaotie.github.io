---
layout: post
title:  "Beam Internal Doc -- Process and Port Tables!"
author: "肖铁(Kevin)"
categories: erlang
---

##Problems

进程表是进程标识到进程结构体指针的映射。进程结构体包含了很多进程相关的杂七杂八的信息，例如指向进程堆的指针，进程的消息队列等等。当erlang运行时系统需要操作一个进程的时候，它就会去进程表中通过进程标识查找进程结构体。其中一个例子就是在发送消息给某个进程的时候。

进程表有很长一段时间的结构其实是一组元素为指向进程结构体的指针的数组。由于运行时系统中的进程标识是28位整数，相对于指针来说它能更好的索引。28位数字被分为2组。比较不重要的那组用来索引数组。重要的那组只用于区分索引到同一个元素时的若干进程指针。只要使用2的幂来表示进程表的大小，我们就有了2^28个不重复的进程标识。

当第一个支持SMP的erlang运行时系统被实现的时候，进程表的结构没什么太大的变化，但是加了2种锁来保护。一个锁用来保护对整个进程表的修改，一个数组的锁用来保护进程表的不同部分。上述的锁策略没什么可细说的。但是需要提及的是，进程表受困于沉重的锁竞争带来的资源消耗，尤其是当有很多修改的时候，或者大量查找的时候。

为了能知道什么时候才能安全的释放一个之前使用的进程结构体，需要对这个结构体的修改进行引用计数。而这样做也有问题，由于会有很多的线程同时查找这个引用计数器，这样做也会导致存储引用计数器的缓存线的竞争。这是由于所有的修改都需要在涉及到的处理器之间通信。


